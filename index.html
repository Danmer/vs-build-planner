<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Primary Meta Tags -->
    <title>Vampire Survivors - Build Planner</title>
    <meta name="title" content="Vampire Survivors - Build Planner" />
    <meta name="description" content="Vampire Survivors - Build Planner" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://danmer.github.io/vs-build-planner" />
    <meta property="og:title" content="Vampire Survivors - Build Planner" />
    <meta property="og:description" content="Vampire Survivors - Build Planner" />
    <meta property="og:image" content="https://danmer.github.io/vs-build-planner/img/preview.jpg" />
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://danmer.github.io/vs-build-planner" />
    <meta property="twitter:title" content="Vampire Survivors - Build Planner" />
    <meta property="twitter:description" content="Vampire Survivors - Build Planner" />
    <meta property="twitter:image" content="https://danmer.github.io/vs-build-planner/img/preview.jpg" />
    <!-- Styles -->
    <link rel="stylesheet" href="./icons.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      html {
        font-family: sans-serif;
        line-height: 1;
        background: #333 radial-gradient(#600, #100) no-repeat fixed;
        color: #fff;
        text-align: center;
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      body {
        margin: 0;
        overflow-x: hidden;
      }
      header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 1em 1em 0.5em;
      }
      h1 {
        margin: 0;
        font-weight: 800;
        font-size: 1.6em;
      }
      section {
        margin: 0.5em;
      }
      .pixels {
        image-rendering: pixelated;
      }
      .flex-row {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
      }
      .flex-col-row {
        display: flex;
        flex-direction: row;
      }
      .flex-row-col {
        display: flex;
        flex-direction: column;
      }
      .app {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      /* Objects and slots */

      .object,
      .slot {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        width: 4.5em;
        height: 4.5em;
        overflow: hidden;
        border: 0.05em outset rgba(100, 100, 100, 0.7);
        background: #987 linear-gradient(-45deg, rgba(0, 0, 0, 0.6), transparent) no-repeat;
        cursor: pointer;
        transition: background-color 0.1s, transform 0.1s;
        box-shadow: 1px 1px 5px #000;
      }
      .slot:hover,
      .object:hover {
        transform: scale(1.4);
        z-index: 2;
      }
      .special {
        background-color: #779;
      }
      .selected {
        background-color: #36f;
      }
      .green {
        background-color: #3c3;
      }
      .red {
        background-color: #f33;
      }
      .yellow {
        background-color: #fc0;
      }
      .greenred {
        background-color: #3c3;
        animation: greenred 2s linear infinite;
      }
      .redgreen {
        background-color: #f33;
        animation: redgreen 2s linear infinite;
      }
      .positive {
        background-color: #3c3;
      }
      .negative {
        background-color: #f33;
      }
      .hidden {
        display: none;
      }
      .empty {
        color: #999;
        font-size: 0.6em;
        font-weight: bold;
      }

      /* Slots */

      .slots {
        font-size: 0.9em;
      }
      .slot.character {
        width: 9em;
        height: 9em;
      }
      .slot.arcana {
        overflow: hidden;
        width: 3em;
        height: 3em;
      }
      .slot.stage {
        display: flex;
        flex-shrink: 0;
        width: 12em;
        height: 4.5em;
        overflow: hidden;
      }
      .weapons .slot:nth-child(n + 7),
      .passives .slot:nth-child(n + 7) {
        opacity: 0.5;
      }
      .slot .icon {
        position: absolute;
        width: 2.5em;
        height: 2.5em;
        background-position: center;
      }
      .slot.character > .icon {
        width: 100%;
        height: 100%;
        font-size: 1.5em;
      }
      .slot.weapon > .icon,
      .slot.passive > .icon {
        background-size: contain;
      }
      .slot.arcana > .icon,
      .slot.stage > .icon {
        width: 100%;
        height: 100%;
        background-size: cover;
      }

      /* Objects */

      .objects {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .object {
        margin: 0.2em;
        border-radius: 0.2em;
      }
      .object.center > .icon {
        position: initial;
        background-position: center center;
      }
      .object.arcana {
        height: 5em;
      }
      .object.stage {
        width: 12em;
        height: 5em;
      }

      /* Objects in objects */

      .object > .title {
        position: absolute;
        top: 0.2em;
        left: 0.2em;
        font-size: 0.7em;
      }
      .object > .roman {
        position: absolute;
        top: 0.2em;
        left: 0.2em;
        padding: 0.2em;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 0.3em;
        font-size: 0.9em;
      }
      .object > .character {
        position: absolute;
      }
      .object > .icon {
        position: absolute;
        left: 0.3em;
        bottom: 0.3em;
      }
      .object.character > .icon {
        bottom: 0.1em;
        width: 5em;
        height: 5em;
        background-position: bottom left;
      }
      .object.weapon > .icon,
      .object.evolution > .icon,
      .object.passive > .icon {
        width: 3em;
        height: 3em;
      }
      .object.arcana > .icon,
      .object.stage > .icon {
        left: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
      }
      .object > .items {
        position: absolute;
        display: flex;
        flex-direction: column;
        flex-wrap: wrap-reverse;
        align-content: end;
        padding: 0.1em;
        height: 100%;
        width: 100%;
      }
      .object.arcana .items,
      .object.stage .items {
        flex-direction: row;
        flex-wrap: wrap-reverse;
        background-image: linear-gradient(to bottom, transparent, rgba(30, 20, 10, 0.5));
      }
      .object.arcana.selected > .items {
        background-color: rgba(30, 30, 250, 0.5);
      }
      .object.stage.selected > .items {
        background-color: rgba(30, 30, 250, 0.5);
      }
      .object > .items > .icon {
        margin: 0.1em;
        width: 1.1em;
        height: 1.1em;
        background-position: right center;
      }
      .object.stage > .items > .icon {
        background-position: center center;
      }
      .object > .impacts {
        position: absolute;
        bottom: 0.2em;
        right: 0.2em;
        background-color: #666;
      }
      .impact {
        width: 0.2em;
        height: 0.3em;
        border-bottom: 1px solid #333;
      }

      /* Buttons */

      .buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin: 0.5em;
        color: #999;
        font-weight: 800;
        font-size: 0.7em;
        text-align: center;
        user-select: none;
      }
      .settings {
        margin-top: -0.5em;
        font-size: 0.6em;
      }
      .button {
        margin: 0.4em;
        padding: 0.7em;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 0.3em;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
      }
      .button:hover {
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        transition: all 0s;
      }
      .button .disabled {
        color: #c66;
      }
      .button .enabled {
        color: #6c6;
      }
      .button .modifier {
        color: #6cc;
      }

      /* Footer */

      footer {
        margin: 2em 0;
        color: #999;
        font-size: 0.8em;
        text-align: center;
      }
      .socials {
        margin-bottom: 1em;
        display: flex;
        align-items: center;
      }
      .social {
        margin-left: 0.3em;
        opacity: 0.8;
        line-height: 0;
      }
      .social:hover {
        opacity: 1;
      }
      .social img {
        width: 1em;
        height: 1em;
      }
      .author {
        color: inherit;
        text-decoration: none;
      }
      .author:hover {
        color: #ccc;
        cursor: pointer;
      }

      @media (max-width: 50em) {
        .flex-col-row {
          flex-direction: column;
        }
        .flex-row-col {
          flex-direction: row;
        }
        .slot.stage {
          margin-top: 7.5em;
          min-width: 9em;
          width: 100%;
        }
        .hidden-visible {
          display: none;
        }
      }
      @keyframes greenred {
        0% {
          background-color: #3c3;
        }
        40% {
          background-color: #f33;
        }
        80% {
          background-color: #3c3;
        }
        100% {
          background-color: #3c3;
        }
      }
      @keyframes redgreen {
        0% {
          background-color: #f33;
        }
        40% {
          background-color: #3c3;
        }
        80% {
          background-color: #f33;
        }
        100% {
          background-color: #f33;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <main class="app" :class="{pixels: config.pixels}" :style="{fontSize: `${config.size}em`}">
        <!-- Header -->
        <header>
          <h1 class="flex-col-row">
            <span>Vampire Survivors</span>
            <span class="hidden-visible">&nbsp;â€”&nbsp;</span>
            <span>Build Planner</span>
            <span class="hidden-visible">&nbsp;(0.8.0)</span>
          </h1>
        </header>

        <!-- Slots -->
        <section class="slots flex-row-col" style="max-width: 60em">
          <div class="flex-col-row">
            <div class="arcanas flex-row-col">
              <div v-for="(arcana, $index) in selectedArcanas" :data-id="arcana.id" class="slot arcana" :class="arcana.type" :title="arcana.title" @click="deleteItem(arcana, selectedArcanas[$index+1])" @mouseenter="onMouseEnter(arcana)" @mouseleave="onMouseLeave()">
                <div class="icon" :class="`icon-${arcana.id}`"></div>
              </div>
              <div v-for="i in (selectedArcanas.length < 3 ? 3 - selectedArcanas.length : 0)" class="slot arcana">
                <small class="empty">ARCANA</small>
              </div>
            </div>
            <div v-if="selectedCharacter.id" class="slot character" :data-id="selectedCharacter.id" :title="selectedCharacter.title" @click="deleteItem(selectedCharacter)" @mouseenter="onMouseEnter(selectedCharacter)" @mouseleave="onMouseLeave(selectedCharacter)">
              <div class="icon" :class="`icon-${selectedCharacter.id}`"></div>
            </div>
            <div v-else class="slot character">
              <small class="empty">CHARACTER</small>
            </div>
            <div class="flex-row-col">
              <div class="flex-col-row weapons">
                <div v-for="(weapon, $index) in evolvedWeapons" :data-id="weapon.id" class="slot weapon" :title="weapon.title" @click="deleteItem(weapon, evolvedWeapons[$index+1])" @mouseenter="onMouseEnter(weapon)" @mouseleave="onMouseLeave()">
                  <div class="icon" :class="`icon-${weapon.id}`"></div>
                </div>
                <div v-for="i in (evolvedWeapons.length < 7 ? 6 - evolvedWeapons.length : 0)" class="slot weapon">
                  <small class="empty">WEAPON</small>
                </div>
              </div>
              <div class="flex-col-row passives">
                <div v-for="(passive, $index) in selectedPassives" :data-id="passive.id" class="slot passive" :title="passive.title" @click="deleteItem(passive, selectedPassives[$index+1])" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave()">
                  <div class="icon" :class="`icon-${passive.id}`"></div>
                </div>
                <div v-for="i in (selectedPassives.length < 7 ? 6 - selectedPassives.length : 0)" class="slot passive">
                  <small class="empty">PASSIVE</small>
                </div>
              </div>
            </div>
          </div>
          <div class="flex-col-row" v-if="selectedStage.id">
            <div class="slot stage" :title="selectedStage.title" @click="deleteItem(selectedStage)" @mouseleave="onMouseLeave()">
              <div class="icon" :class="`icon-${selectedStage.id}`"></div>
            </div>
            <div class="flex-row">
              <div class="flex-col-row">
                <div v-for="(passive, $index) in selectedStage.items.slice(0, 12).slice(0, -4)" :data-id="passive.id" class="slot passive" :title="passive.title" @click="deleteItem(passive, selectedPassives[$index+1])" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave()">
                  <div class="icon" :class="`icon-${passive.id}`"></div>
                </div>
              </div>
              <div class="flex-col-row">
                <div v-for="(passive, $index) in selectedStage.items.slice(8, 20).slice(0, -4)" :data-id="passive.id" class="slot passive" :title="passive.title" @click="deleteItem(passive, selectedPassives[$index+1])" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave()">
                  <div class="icon" :class="`icon-${passive.id}`"></div>
                </div>
              </div>
              <div class="flex-col-row">
                <div v-for="(passive, $index) in selectedStage.items.slice(-4)" :data-id="passive.id" class="slot passive" :title="passive.title" @click="deleteItem(passive, selectedPassives[$index+1])" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave()">
                  <div class="icon" :class="`icon-${passive.id}`"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Buttons-->
        <div class="buttons">
          <span class="button" @click="reset($event)">RESET</span>
          <span class="button" @click="copyLink($event)">COPY LINK</span>
          <span class="button" @click="copyEmojis($event)">COPY EMOJIS</span>
          <span class="button" @click="copyImage($event)">COPY IMAGE</span>
          <span class="button" @click="saveImage($event)">SAVE IMAGE</span>
          <span class="button" @click="settings = !settings">SETTINGS</span>
        </div>
        <div v-if="settings" class="buttons settings">
          <span class="button" @click="config.evolutions = !config.evolutions">EVOLUTIONS: <span :class="(config.evolutions ? 'enabled' : 'disabled')">{{config.evolutions ? 'ON' : 'OFF'}}</span></span>
          <span class="button" @click="config.combinations = !config.combinations">COMBINATIONS: <span :class="(config.combinations ? 'enabled' : 'disabled')">{{config.combinations ? 'ON' : 'OFF'}}</span></span>
          <span class="button" @click="config.impacts = !config.impacts">IMPACTS: <span :class="(config.impacts ? 'enabled' : 'disabled')">{{config.impacts ? 'ON' : 'OFF'}}</span></span>
          <span class="button" @click="config.titles = !config.titles">TITLES: <span :class="(config.titles ? 'enabled' : 'disabled')">{{config.titles ? 'ON' : 'OFF'}}</span></span>
          <span class="button" @click="config.pixels = !config.pixels">PIXELS: <span :class="(config.pixels ? 'enabled' : 'disabled')">{{config.pixels ? 'ON' : 'OFF'}}</span></span>
          <span class="button" @click="config.size -= 0.1">SIZE <span class="modifier">-</span></span>
          <span class="button" style="margin-left: 0" @click="config.size += 0.1">SIZE <span class="modifier">+</span></span>
        </div>

        <!-- Characters -->
        <section style="max-width: 85em">
          <div class="objects">
            <div v-for="character in characters" :data-id="character.id" class="object character" :class="{selected: selectedCharacter.id === character.id, special: character.special}" :title="character.title" @click="toggleItem(character)" @mouseenter="onMouseEnter(character)" @mouseleave="onMouseLeave(character)">
              <div class="icon" :class="`icon-${character.id}`"></div>
              <div class="items">
                <div v-for="item in character.items" class="icon" :class="`icon-${item.id}`" :title="item.title"></div>
              </div>
              <div v-if="config.titles" class="title">{{character.id}}</div>
            </div>
          </div>
        </section>

        <!-- Weapons -->
        <section style="max-width: 70em">
          <div class="objects">
            <div v-for="weapon in weapons" :data-id="weapon.id" class="object weapon" :class="{selected: weapon.selected, special: weapon.special, center: !config.combinations && !config.titles && !config.impacts}" :title="weapon.title" @click="toggleItem(weapon)" @mouseenter="onMouseEnter(weapon)" @mouseleave="onMouseLeave()">
              <div class="icon" :class="`icon-${weapon.id}`"></div>
              <div v-if="config.impacts" class="impacts">
                <div v-for="impact in impactsById[weapon.id]" class="impact" :class="itemsById[impact.substring(1)].selected ? (impact[0] === '+' ? 'positive' : 'negative') : '' " :title="impact.substring(1)"></div>
              </div>
              <div v-if="config.combinations" class="items">
                <div v-for="item in weapon.items" class="icon" :class="`icon-${item.id}`" :title="item.title"></div>
              </div>
              <div v-if="config.titles" class="title">{{weapon.id}}</div>
            </div>
          </div>
        </section>

        <!-- Evolutions -->
        <section v-if="config.evolutions" style="max-width: 50em">
          <div class="objects">
            <div v-for="evolution in evolutions" :data-id="evolution.id" class="object evolution" :class="{selected: evolution.selected, special: evolution.special, center: !config.combinations && !config.titles && !config.impacts}" :title="evolution.title" @click="toggleItem(evolution)" @mouseenter="onMouseEnter(evolution)" @mouseleave="onMouseLeave()">
              <div class="icon" :class="`icon-${evolution.id}`"></div>
              <div v-if="config.impacts" class="impacts">
                <div v-for="impact in impactsById[evolution.id]" class="impact" :class="itemsById[impact.substring(1)].selected ? (impact[0] === '+' ? 'positive' : 'negative') : '' " :title="impact.substring(1)"></div>
              </div>
              <div v-if="config.combinations" class="items">
                <div v-for="item in evolution.items" class="icon" :class="`icon-${item.id}`" :title="item.title"></div>
              </div>
              <div v-if="config.titles" class="title">{{evolution.id}}</div>
            </div>
          </div>
        </section>

        <!-- Passives -->
        <section style="max-width: 55em">
          <div class="objects">
            <div v-for="passive in passives" :data-id="passive.id" class="object passive" :class="{selected: passive.selected, special: passive.special, center: !config.combinations && !config.titles && !config.impacts}" :title="passive.title" @click="toggleItem(passive)" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave()">
              <div class="icon" :class="`icon-${passive.id}`"></div>
              <div v-if="config.impacts" class="impacts">
                <div v-for="weapon in evolvedWeapons" class="impact" :class="impactsById[weapon.id] && (impactsById[weapon.id].includes('-' + passive.id) ? 'negative' : impactsById[weapon.id].includes('+' + passive.id) ? 'positive' : 'hidden')" :title="weapon.title"></div>
                <div v-if="selectedCharacter.id" class="impact" :class="impactsById[selectedCharacter.id] && (impactsById[selectedCharacter.id].includes('-' + passive.id) ? 'negative' : impactsById[selectedCharacter.id].includes('+' + passive.id) ? 'positive' : 'hidden')" :title="selectedCharacter.title"></div>
              </div>
              <div v-if="config.combinations" class="items">
                <div v-for="item in passive.items" class="icon" :class="`icon-${item.id}`" :title="item.title"></div>
              </div>
              <div v-if="config.titles" class="title">{{passive.id}}</div>
            </div>
          </div>
        </section>

        <!-- Arcanas -->
        <section>
          <div class="objects">
            <div v-for="arcana in arcanas" :data-id="arcana.id" class="object arcana" :class="{selected: arcana.selected, special: arcana.special, center: !config.titles}" :title="arcana.title" @click="toggleItem(arcana)" @mouseenter="onMouseEnter(arcana)" @mouseleave="onMouseLeave()">
              <div class="icon" :class="`icon-${arcana.id}`"></div>
              <div class="items">
                <div v-for="item in arcana.items" class="icon" :class="`icon-${item.id}`" :title="item.title"></div>
              </div>
              <div v-if="config.titles" class="roman">{{arcana.roman}}</div>
            </div>
          </div>
        </section>

        <!-- Stages -->
        <section style="max-width: 65em">
          <div class="objects">
            <div v-for="stage in stages" :data-id="stage.id" class="object stage center" :class="{selected: stage.selected, special: stage.special}" :title="stage.title" @click="toggleItem(stage)" @mouseenter="onMouseEnter(stage)" @mouseleave="onMouseLeave()">
              <div class="icon" :class="`icon-${stage.id}`"></div>
              <div class="items">
                <div v-for="item in stage.items.slice(-4)" class="icon" :class="`icon-${item.id}`" :title="item.title"></div>
                <div style="width: 100%"></div>
                <div v-for="item in stage.items.slice(0, -4)" class="icon" :class="`icon-${item.id}`" :title="item.title"></div>
              </div>
              <div v-if="config.titles" class="title">{{stage.id}}</div>
            </div>
          </div>
        </section>

        <!-- Footer -->
        <footer>
          <div class="socials">
            <span>Vampire Survivors:</span>
            <a class="social" href="https://store.steampowered.com/app/1794680/Vampire_Survivors/" target="_blank"><img src="./img/logos/steam.svg" alt="" /></a>
            <a class="social" href="https://twitter.com/poncle_vampire" target="_blank"><img src="./img/logos/twitter.svg" alt="" /></a>
            <a class="social" href="https://www.instagram.com/vampire_survivors/" target="_blank"><img src="./img/logos/instagram.svg" alt="" /></a>
            <a class="social" href="https://www.tiktok.com/@vampire_survivors" target="_blank"><img src="./img/logos/tiktok.svg" alt="" /></a>
            <a class="social" href="https://discord.com/invite/vampire-survivors" target="_blank"><img src="./img/logos/discord.svg" alt="" /></a>
            <a class="social" href="https://www.reddit.com/r/VampireSurvivors/" target="_blank"><img src="./img/logos/reddit.svg" alt="" /></a>
          </div>
          <div>Website is made by <a class="author" href="mailto:danmer.ekb@gmail.com">Danmer</a>, 2022</div>
        </footer>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.32/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="./data.js"></script>
    <script>
      const { createApp, ref, reactive, computed, watch, watchEffect, nextTick } = Vue

      createApp({
        setup() {
          const config = useConfig()

          const settings = ref(false)

          const selectedIds = reactive(new Set(getHashIds()))

          let hoveredId = ''

          // data from data.js
          const { characters, weapons, evolutions, powerups, passives, arcanas, stages, pickups, structures } = window.vs

          // List of all objects
          const items = [...powerups, ...passives, ...weapons, ...evolutions, ...arcanas, ...characters, ...stages, ...pickups, ...structures]
          const itemsById = items.reduce((itemsById, item) => Object.assign(itemsById, { [item.id]: item }), {})

          // Extra fields
          for (const character of characters) {
            character.type = 'character'
            character.fullName = `${character.prefix ? character.prefix + ' ' : ''}${character.name}${character.surname ? ' ' + character.surname : ''}`
          }
          for (const weapon of weapons) {
            weapon.type = 'weapon'
          }
          for (const passive of passives) {
            passive.type = 'passive'
          }
          for (const evolution of evolutions) {
            evolution.type = 'evolution'
            evolution.weaponIds = evolution.itemIds.filter((itemId) => itemsById[itemId].type === 'weapon')
            evolution.evolutionIds = evolution.itemIds.filter((itemId) => itemsById[itemId].type === 'evolution')
            evolution.passiveIds = evolution.itemIds.filter((itemId) => itemsById[itemId].type === 'passive')
            for (const itemId of evolution.itemIds) {
              itemsById[itemId].evolutionId = evolution.id
              itemsById[itemId].itemIds = itemsById[itemId].itemIds || evolution.itemIds.filter((id) => id !== itemId)
            }
            // find level 2 evolutions containing the same items
            const evolution2 = evolutions.find((evo) => evo.itemIds.includes(evolution.id))
            if (evolution2) {
              for (const itemId of evolution2.itemIds) {
                evolution.evolutionId = evolution2.id
              }
            }
          }
          for (const arcana of arcanas) {
            arcana.type = 'arcana'
            arcana.roman = toRoman(+arcana.id.substring(6))
          }
          for (const stage of stages) {
            stage.type = 'stage'
            stage.itemIds.push('ring1', 'ring2', 'sign1', 'sign2')
          }
          for (const item of items) {
            item.items = item.itemIds ? item.itemIds.map((itemId) => itemsById[itemId]) : []
            item.evolution = item.evolutionId && itemsById[item.evolutionId]
            item.title = (item.fullName || item.name) + (item.type === 'weapon' || item.type === 'passive' ? ` (Rarity: ${item.rarity})` : '') + (item.price ? ` (Price: ${item.price})` : '') + (item.description ? `\n${item.description}` : '')
          }

          const impactsById = computed(() => {
            const newImpactsById = {
              antonio: ['+armor', '+health', '+might'],
              imelda: ['+growth'],
              pasqualina: ['+speed'],
              gennaro: ['+health', '+amount'],
              arca: ['+cooldown', '+might'],
              porta: ['+area'],
              lama: ['+health', '+wings', '+might', '+curse'],
              poe: ['+magnet', '-health'],
              clerici: ['+health', '+recovery'],
              dommario: ['+speed', '+duration', '-wings'],
              krochi: ['+revival', '+wings'],
              christine: ['+cooldown', '+wings', '-might', '-health'],
              pugnala: ['+wings', '+might'],
              poppea: ['+wings', '+duration'],
              mortaccio: ['+amount'],
              cavallo: ['+amount'],
              ramba: ['+amount'],
              giovanna: ['+wings', '+speed'],
              osole: ['+amount'],
              concetta: ['+wings', '+curse', '+area'],
              gallo: ['+growth', '+duration', '+cooldown', '-greed'],
              divano: ['+armor', '+recovery', '+luck', '-greed'],
              assunta: ['+might', '+speed', '+duration', '+area', '+wings', '+curse'],
              ambrojoe: ['+amount', '+luck', '+greed', '+magnet'],
              exdash: ['+luck', '-health', '-wings', '-might', '-area', '-speed', '-duration', '-cooldown'],
              toastie: ['+wings', '+luck', '+armor', '~health', '-might', '-area', '-speed', '-duration', '-cooldown'],
              smith: ['+wings', '+luck', '+recovery', '-health', '~cooldown', '~might', '~area', '~speed', '~duration'],
              marrabbio: ['+health', '+might', '+wings', '+curse', '-speed', '-greed'],
              minnah: ['+health', '+luck', '+recovery', '-might', '~duration', '~area', '!cooldown', '!might', '!speed'],
              peppino: ['+health', '+armor', '+magnet', '-wings', '-area'],
              reaper: ['+health', '+wings', '+might'],
              leda: ['+armor', '+might', '+area', '+cooldown', '-wings', '-greed'],
              arcana3: ['+cooldown', '+garlic', '+garlic_', '+water', '+water_', '+lightning', '+lightning_', '+cart'],
              arcana4: ['+revival', '+health', '+armor', '+might', '+area', '+duration', '+speed'],
              arcana5: ['~speed'],
              arcana6: ['+recovery', '+whip_', '+garlic_', '+revival', '+flowers'],
              arcana7: ['+knife', '+knife_', '+axe', '+axe_', '+guns1', '+guns2', '+cart'],
              arcana8: [],
              arcana10: ['+amount', '+bone', '+cherry', '+cart', '+flowers'],
              arcana11: ['+magicwand', '+magicwand_', '+firewand', '+firewand_', '+cross', '+cross_', '+cart'],
              arcana12: ['+lancet'],
              arcana14: ['+magicwand', '+magicwand_', '+runetracer', '+runetracer_', '+guns2'],
              arcana15: ['+cat_', '+greed'],
              arcana16: ['+knife', '+knife_', '+whip', '+whip_', '+axe', '+axe_', '+cross_', '+vento', '+vento_'],
              arcana17: ['~duration'],
              arcana18: ['~area'],
              arcana19: ['+firewand', '+firewand_', '+guns1', '+pinion_'],
              arcana20: [],
              axe: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              axe_: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              bible: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration'],
              bible_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration'],
              bird1: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+wings'],
              bird_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+wings'],
              bird2: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+wings'],
              bone: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration'],
              cart: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              cat: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+luck'],
              cat_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+luck'],
              cherry: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+luck'],
              cross: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              cross_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+luck'],
              firewand: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              firewand_: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              flowers: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+wings'],
              furniture: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration'],
              garlic: ['+cooldown', '+might', '+area'],
              garlic_: ['+cooldown', '+might', '+area', '+recovery'],
              guns1: ['+cooldown', '+might', '+area', '+amount', '+speed', '+luck'],
              guns_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+luck', '+revival'],
              guns2: ['+cooldown', '+might', '+area', '+amount', '+speed', '+luck'],
              knife: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              knife_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+luck'],
              lancet: ['+cooldown', '+duration'],
              laurel: ['+cooldown'],
              lancet_: ['+cooldown', '+duration'],
              laurel_: ['+cooldown', '+area', '+might', '+armor'],
              lightning: ['+cooldown', '+might', '+area', '+amount'],
              lightning_: ['+cooldown', '+might', '+area', '+amount'],
              magicwand: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              magicwand_: ['+cooldown', '+might', '+area', '+amount', '+speed'],
              mana: ['+cooldown', '+might', '+area', '+duration'],
              mana_: ['+cooldown', '+might', '+area', '+duration'],
              pentagram: ['+cooldown', '+luck'],
              pentagram_: ['+cooldown'],
              pinion: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+wings'],
              pinion_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+wings'],
              runetracer: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration'],
              runetracer_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration'],
              vento: ['+cooldown', '+might', '+area', '+amount', '+speed', '+wings', '+luck'],
              vento_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+wings', '+luck'],
              water: ['+cooldown', '+might', '+area', '+amount', '+duration'],
              water_: ['+cooldown', '+might', '+area', '+amount', '+speed', '+duration', '+wings'],
              whip: ['+cooldown', '+might', '+area', '+amount'],
              whip_: ['+cooldown', '+might', '+area', '+amount', '+luck'],
              torrona: ['+might', '+speed', '+duration', '+area', '+curse'],
              ring1: ['+duration', '+area'],
              ring2: ['+curse'],
              sign1: ['+recovery', '+health'],
              sign2: ['+curse'],
            }

            for (const itemId in newImpactsById) {
              const impactIds = newImpactsById[itemId]
              const item = itemsById[itemId]
              // add dynamic impacts with conditions
              if ((item.type === 'weapon' || item.type === 'evolution' || item.type === 'passive') && (impactIds.includes('+area') || impactIds.includes('+duration'))) {
                impactIds.push('+ring1')
              }
              if ((item.type === 'weapon' || item.type === 'evolution' || item.type === 'passive') && impactIds.includes('+curse')) {
                impactIds.push('+ring2')
              }
              if ((item.type === 'weapon' || item.type === 'evolution' || item.type === 'passive') && (impactIds.includes('+recovery') || impactIds.includes('+health'))) {
                impactIds.push('+sign1')
              }
              if ((item.type === 'weapon' || item.type === 'evolution' || item.type === 'passive') && (impactIds.includes('+might') || impactIds.includes('+speed') || impactIds.includes('+duration') || impactIds.includes('+area'))) {
                impactIds.push('+torrona')
              }
              if (selectedIds.has('arcana16') && ['axe', 'axe_', 'knife', 'knife_', 'whip', 'whip_', 'vento', 'vento_'].includes(itemId)) {
                impactIds.push('+luck')
              }
              if ((item.type === 'weapon' || item.type === 'evolution' || item.type === 'passive') && (impactIds.includes('+cooldown') || impactIds.includes('+might')) && evolvedWeapons.value.length < 6) {
                impactIds.push('+arcana20')
              }
              if (item.id === 'arcana20' && evolvedWeapons.value.length < 6) {
                impactIds.push('+cooldown', '+might')
              }
              // TODO: minnah does not benefit from dynamic arcanas: (V), (XVIII), (XVII)
              // add weapon impacts to passive
              for (const impactId of impactIds) {
                const id = impactId.substring(1)
                const newImpactId = impactId[0] + itemId
                newImpactsById[id] = newImpactsById[id] || []
                if (!newImpactsById[id].includes(newImpactId)) {
                  newImpactsById[id].push(newImpactId)
                }
              }
            }

            // sort impacts (selected - down, others - up)
            for (const itemId in newImpactsById) {
              newImpactsById[itemId].sort((id1, id2) => (itemsById[id1.substring(1)].selected && !itemsById[id2.substring(1)].selected ? 1 : -1))
            }

            return newImpactsById
          })

          const selectedItems = computed(() =>
            Array.from(selectedIds)
              .filter((itemId) => itemId)
              .map((itemId) => itemsById[itemId])
          )
          const selectedCharacter = computed(() => selectedItems.value.find((item) => item.type === 'character') || { id: '', emoji: '', itemIds: [] })
          const selectedStage = computed(() => selectedItems.value.find((item) => item.type === 'stage') || { id: '', emoji: '', itemIds: [] })
          const selectedWeapons = computed(() => selectedItems.value.filter((item) => item.type === 'weapon').sort((a, b) => (a.fixed && !b.fixed ? -1 : 0)))
          const selectedPassives = computed(() => selectedItems.value.filter((item) => item.type === 'passive' && !selectedStage.value.itemIds.includes(item.id)))
          const selectedArcanas = computed(() => selectedItems.value.filter((item) => item.type === 'arcana'))
          const evolvedWeapons = computed(() => Array.from(new Set(selectedWeapons.value.map((weapon) => (weapon.evolved ? (weapon.evolution.evolved ? weapon.evolution.evolution : weapon.evolution) : weapon)))))

          watch(
            selectedIds,
            () => {
              const idsArray = Array.from(selectedIds)
              for (const item of items) {
                // selected if it's manually selected or it's a character's item
                item.selected = idsArray.includes(item.id) || selectedStage.value.itemIds.includes(item.id)
                // protected from deleting if it's a character's item
                item.fixed = selectedCharacter.value.itemIds.includes(item.id) || selectedCharacter.value.itemIds.includes(item.evolutionId)
              }
              for (const evolution of evolutions) {
                // selected if all required items are selected or if it's a character's item
                evolution.selected = evolution.itemIds.every((id) => idsArray.includes(id)) || selectedCharacter.value.itemIds.includes(evolution.id)
              }
              for (const weapon of weapons) {
                // evolved if all required items are selected
                weapon.evolved = weapon.evolutionId && (weapon.evolution.items.every((it) => it.selected) || selectedCharacter.value.itemIds.includes(weapon.evolutionId))
              }
              for (const evolution of evolutions) {
                // evolved if all required items are selected or evolved
                evolution.evolved = evolution.evolutionId && (evolution.evolution.items.every((it) => it.selected) || selectedCharacter.value.itemIds.includes(evolution.evolutionId))
              }
              updateHash()
            },
            { immediate: true }
          )

          watch(
            selectedCharacter,
            (newCharacter, oldCharacter) => {
              // delete items of the previous character
              if (oldCharacter) {
                for (const itemId of oldCharacter.itemIds) {
                  unselectId(itemId)
                }
              }
              // add items of the new character
              for (const itemId of newCharacter.itemIds) {
                selectId(itemId)
              }
            },
            { immediate: true }
          )

          window.config = config
          window.itemsById = itemsById

          window.addEventListener('hashchange', updateSelectedIds)

          function getHashIds() {
            return location.hash
              .substring(1)
              .split(',')
              .filter((id) => id)
          }

          function updateSelectedIds() {
            selectedIds.clear()
            for (const id of getHashIds()) {
              selectedIds.add(id)
            }
          }

          function updateHash() {
            const newHash = (selectedCharacter.value.id ? [selectedCharacter.value] : [])
              .concat(selectedWeapons.value, selectedPassives.value, selectedArcanas.value, selectedStage.value)
              .map((item) => item.id)
              .filter((id) => id)
              .join()
            if ('#' + newHash !== location.hash) {
              location.hash = newHash
            }
          }

          function showImpacts(object) {
            if (!object) {
              return false
            }
            if (object.type !== 'arcana' && object.itemIds) {
              for (const itemId of object.itemIds.concat(object.evolutionId)) {
                document.querySelectorAll(`[data-id="${itemId}"]`).forEach((element) => {
                  element.classList.add('yellow')
                })
              }
            }
            if (impactsById.value[object.id]) {
              for (const impact of impactsById.value[object.id]) {
                document.querySelectorAll(`[data-id="${impact.substring(1)}"]`).forEach((element) => {
                  element.classList.add(impact[0] === '+' ? 'green' : impact[0] === '-' ? 'red' : impact[0] === '~' ? 'greenred' : impact[0] === '!' ? 'redgreen' : 0)
                })
              }
            }
          }

          function hideImpacts() {
            document.querySelectorAll(`.yellow, .green, .red, .greenred, .redgreen`).forEach((element) => {
              element.classList.remove('yellow', 'green', 'red', 'greenred', 'redgreen')
            })
          }

          function onMouseEnter(object) {
            hoveredId = object.id
            // character's gif animation
            if (object.type === 'character') {
              const iconElements = document.querySelectorAll(`[data-id="${object.id}"] > .icon`)
              for (const iconElement of iconElements) {
                const image = new Image()
                image.onload = () => {
                  if (object.id === hoveredId) {
                    iconElement.style.backgroundImage = `url("./img/characters/${object.id}.gif")`
                  }
                }
                image.src = `./img/characters/${object.id}.gif`
              }
            }
            showImpacts(object)
          }

          function onMouseLeave(object) {
            hoveredId = ''
            if (object && object.type === 'character') {
              const iconElements = document.querySelectorAll(`[data-id="${object.id}"] > .icon`)
              for (const iconElement of iconElements) {
                iconElement.style.backgroundImage = ''
              }
            }
            hideImpacts()
          }

          function unselectId(itemId) {
            const item = itemsById[itemId]
            if (item.type === 'evolution') {
              for (const weaponId of item.weaponIds.concat(item.evolutionIds)) {
                unselectId(weaponId)
              }
            } else {
              if (!item.fixed) {
                selectedIds.delete(item.id)
              }
            }
          }

          function selectId(itemId) {
            const item = itemsById[itemId]
            switch (item.type) {
              case 'character':
                if (selectedCharacter.value.id) {
                  selectedIds.delete(selectedCharacter.value.id)
                }
                selectedIds.add(item.id)
                break
              case 'evolution':
                const itemids = selectedCharacter.value.itemIds.includes(item.id) ? item.weaponIds : item.itemIds
                for (const itemId of itemids) {
                  selectId(itemId)
                }
                break
              case 'arcana':
                if (selectedArcanas.value.length < 3) {
                  selectedIds.add(item.id)
                }
                break
              case 'stage':
                if (selectedStage.value.id) {
                  selectedIds.delete(selectedStage.value.id)
                }
                selectedIds.add(item.id)
                for (const itemId of item.itemIds) {
                  selectId(itemId)
                }
                break
              default:
                selectedIds.add(item.id)
            }
          }

          // manual toggle
          function toggleItem(item) {
            if (item.selected) {
              unselectId(item.id)
            } else {
              selectId(item.id)
              nextTick(() => {
                showImpacts(item)
              })
            }
          }

          // manual delete
          function deleteItem(item, nextItem) {
            unselectId(item.id)
            if (nextItem) {
              hideImpacts()
              showImpacts(nextItem)
            } else {
              hideImpacts()
            }
          }

          function reset(event) {
            selectedIds.clear()
            highlightElement(event.target, '#3c3')
          }

          function saveImage(event) {
            domtoimage
              .toPng(document.querySelector('.slots'))
              .then((dataUrl) => {
                var link = document.createElement('a')
                link.download = `vs-build_${new Date().toISOString().substring(0, 19).replaceAll(':', '-')}.png`
                link.href = dataUrl
                link.click()
                highlightElement(event.target, '#3c3')
              })
              .catch(() => highlightElement(event.target, '#c33'))
          }

          function copyImage(event) {
            domtoimage.toBlob(document.querySelector('.slots')).then((dataBlob) => {
              navigator.clipboard
                .write([new ClipboardItem({ 'image/png': dataBlob })])
                .then(() => highlightElement(event.target, '#3c3'))
                .catch(() => highlightElement(event.target, '#c33'))
            })
          }

          function copyLink(event) {
            const text = location.href
            navigator.clipboard
              .writeText(text)
              .then(() => highlightElement(event.target, '#3c3'))
              .catch(() => highlightElement(event.target, '#c33'))
          }

          function copyEmojis(event) {
            let text = `Build: <${location.href}>`
            if (selectedCharacter.value.id || selectedArcanas.value.length) {
              text += `\n${selectedCharacter.value.emoji}${selectedCharacter.value.emoji ? ' ' : ''}${selectedArcanas.value.map((item) => item.emoji).join(' ')}`
            }
            if (evolvedWeapons.value.length) {
              text += `\n${evolvedWeapons.value.map((item) => item.emoji).join(' ')}`
            }
            if (selectedPassives.value.length) {
              text += `\n${selectedPassives.value
                .concat(selectedStage.value.items)
                .map((item) => item.emoji)
                .join(' ')}`
            }
            navigator.clipboard
              .writeText(text)
              .then(() => highlightElement(event.target, '#3c3'))
              .catch(() => highlightElement(event.target, '#c33'))
          }

          function toRoman(number) {
            const roman = { X: 10, IX: 9, V: 5, IV: 4, I: 1 }
            let result = ''
            for (let i of Object.keys(roman)) {
              let q = Math.floor(number / roman[i])
              number -= q * roman[i]
              result += i.repeat(q)
            }
            return result || 'O'
          }

          function highlightElement(target, color = '#3c3') {
            if (target) {
              target.style.color = color
              setTimeout(() => {
                target.style.color = ''
              }, 200)
            }
          }

          function useConfig(storageKey = 'vs-build') {
            const defaultConfig = { impacts: true, pixels: true, titles: true, evolutions: false, combinations: true, size: 1, version: 2 }

            const userConfig = loadUserConfig()

            if (userConfig.version !== defaultConfig.version) {
              Object.assign(userConfig, defaultConfig)
            }

            const config = reactive({ ...defaultConfig, ...(userConfig.version === defaultConfig.version ? userConfig : {}) })

            watch(config, saveUserConfig)

            function loadUserConfig() {
              return JSON.parse(localStorage.getItem(storageKey) || '{}')
            }

            function saveUserConfig() {
              for (const param in config) {
                if (config[param] === defaultConfig[param] && param !== 'version') {
                  delete userConfig[param]
                } else {
                  userConfig[param] = config[param]
                }
              }
              localStorage.setItem(storageKey, JSON.stringify(userConfig))
            }

            return config
          }

          return {
            config,
            settings,
            characters,
            weapons,
            passives,
            evolutions,
            arcanas,
            stages,
            itemsById,
            impactsById,
            selectedStage,
            selectedCharacter,
            selectedWeapons,
            selectedPassives,
            selectedArcanas,
            evolvedWeapons,
            onMouseEnter,
            onMouseLeave,
            toggleItem,
            deleteItem,
            saveImage,
            copyImage,
            copyLink,
            copyEmojis,
            reset,
          }
        },
      }).mount('#app')
    </script>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
      ;(function (m, e, t, r, i, k, a) {
        m[i] =
          m[i] ||
          function () {
            ;(m[i].a = m[i].a || []).push(arguments)
          }
        m[i].l = 1 * new Date()
        ;(k = e.createElement(t)), (a = e.getElementsByTagName(t)[0]), (k.async = 1), (k.src = r), a.parentNode.insertBefore(k, a)
      })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym')
      ym(88260279, 'init', { clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true, trackHash: true })
    </script>
    <noscript>
      <div><img src="https://mc.yandex.ru/watch/88260279" style="position: absolute; left: -9999px" alt="" /></div>
    </noscript>
    <!-- /Yandex.Metrika counter -->
  </body>
</html>
