<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Primary Meta Tags -->
    <title>Vampire Survivors - Build Planner</title>
    <meta name="title" content="Vampire Survivors - Build Planner" />
    <meta name="description" content="Vampire Survivors - Build Planner" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://danmer.github.io/vs-build-planner" />
    <meta property="og:title" content="Vampire Survivors - Build Planner" />
    <meta property="og:description" content="Vampire Survivors - Build Planner" />
    <meta property="og:image" content="https://danmer.github.io/vs-build-planner/img/preview.jpg" />
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://danmer.github.io/vs-build-planner" />
    <meta property="twitter:title" content="Vampire Survivors - Build Planner" />
    <meta property="twitter:description" content="Vampire Survivors - Build Planner" />
    <meta property="twitter:image" content="https://danmer.github.io/vs-build-planner/img/preview.jpg" />
    <style>
      * {
        box-sizing: border-box;
      }
      html {
        font-family: 'Courier New', Courier, monospace;
        line-height: 1;
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      body {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        min-height: 100vh;
        background: #333 linear-gradient(-45deg, #000, #422) no-repeat;
        color: #eee;
        white-space: nowrap;
        text-align: center;
      }
      h1 {
        display: flex;
        justify-content: center;
        margin: 0 0 0.5em;
        white-space: normal;
      }
      header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 1em;
      }
      section {
        margin: 0.5em;
      }
      .pixels {
        image-rendering: pixelated;
      }
      .flex {
        display: flex;
      }
      .app {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .slots {
        display: flex;
        /* border: 0.1em solid #888; */
      }
      .slot {
        position: relative;
        flex-shrink: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 2.5em;
        height: 2.5em;
        border: 0.05em solid #aa9;
        background: #333 linear-gradient(-45deg, #222, #998) no-repeat;
        box-shadow: 1px 1px 5px #000;
        transition: transform 0.1s;
        font-size: 2em;
      }
      .slot:not(.character):hover {
        /* background-image: linear-gradient(-45deg, #400, #f66);
        border-color: #f99 !important; */
        background: #333 linear-gradient(-45deg, #333, #bbb) no-repeat;
        transform: scale(1.3);
        z-index: 2;
        cursor: pointer;
      }
      .slot.character {
        /* width: 20vw;
        height: 20vw; */
        width: 5em;
        height: 5em;
        border-width: 0.1em;
      }
      .slot:nth-child(n + 7) {
        opacity: 0.5;
      }
      .objects {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .object {
        position: relative;
        margin: 0.2em;
        padding: 0.2em;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        width: 5em;
        height: 5em;
        border-radius: 0.2em;
        border: 0.15em solid #aa9;
        background: #333 linear-gradient(-45deg, #222, #998) no-repeat;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 1px 1px 5px #000;
      }
      .object:hover {
        /* background-image: linear-gradient(-45deg, #024, #06f);
        border-color: #3cf !important; */
        border: 0.15em solid #ddc;
        background: #333 linear-gradient(-45deg, #333, #ddd) no-repeat;
        transform: scale(1.3);
        z-index: 2;
      }
      .green {
        background-image: linear-gradient(-45deg, #040, #3c3);
      }
      .blue {
        background-image: linear-gradient(-45deg, #024, #69f);
      }
      .yellow {
        background-image: linear-gradient(-45deg, #430, #fc0);
      }
      .object.selected {
        background-image: linear-gradient(-45deg, #024, #36f);
        border-color: #39f;
      }
      .green.blue {
        background-image: linear-gradient(-45deg, #044, #3ff);
        border-color: #6cf;
      }
      .green.selected {
        background-image: linear-gradient(-45deg, #044, #3ff);
        border-color: #6cf;
      }

      .object.character,
      .object.passive,
      .object.weapon {
        align-items: flex-start;
        justify-content: flex-end;
      }
      .object.center,
      .object.evolution {
        align-items: center;
        justify-content: center;
      }

      .object > .character {
        position: absolute;
        font-size: 1em;
      }
      .object > .passive,
      .object > .weapon,
      .object > .evolution {
        font-size: 2em;
      }
      .object > .weapons,
      .object > .evolutions {
        position: absolute;
        right: 0.1em;
        top: 0.1em;
        font-size: 1em;
      }
      .object > .impacts {
        display: flex;
        margin-top: 0.25em;
        font-size: 0.5em;
      }
      .object > .impacts > div {
        margin: 0 -0.2em !important;
      }
      .empty {
        color: #999;
        font-size: 0.3em;
        font-weight: bold;
      }
      .buttons {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-size: 0.7em;
        font-weight: bold;
        color: #999;
        user-select: none;
      }
      .buttons .flex .button:nth-child(n + 2) {
        margin-left: 0;
      }
      .button {
        margin: 0.8em 0.5em 0;
        cursor: pointer;
        padding: 0.3em 0.5em;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 0.3em;
      }
      .button:hover {
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
      }
      footer {
        margin: 1em 0;
        color: #999;
      }
      .socials {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.3em;
      }
      .social {
        margin-left: 0.3em;
        opacity: 0.5;
      }
      .social:hover {
        opacity: 1;
      }
      .social img {
        width: 1em;
        height: 1em;
      }
      .author {
        color: inherit;
        text-decoration: none;
      }
      .author:hover {
        color: #ccc;
        cursor: pointer;
      }
      @media (max-width: 50em) {
        .slots {
          flex-direction: column;
          align-items: center;
        }
        .slots > .flex-1 {
          display: flex;
        }
        .slots > .flex-1 > .flex {
          flex-direction: column;
        }
        h1 {
          flex-direction: column;
        }
        .lg {
          display: none;
        }
        .buttons {
          max-width: 20em;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <main class="app" :class="{pixels: config.pixels}" :style="{fontSize: `${config.size}em`}">
        <!-- Build -->
        <header>
          <h1>
            <span>Vampire Survivors</span>
            <span class="lg">&nbsp;—&nbsp;</span>
            <span>Build Planner ({{config.version}})</span>
          </h1>
          <div class="slots">
            <div v-if="selectedCharacter" class="character slot" @mouseenter="startAnimation(selectedCharacter)" @mouseleave="stopAnimation(selectedCharacter)" :title="selectedCharacter.name">
              <div :style="selectedCharacter.style"></div>
            </div>
            <div v-else class="character slot">
              <div class="empty">CHARACTER</div>
            </div>
            <div class="flex-1">
              <div class="flex">
                <div v-for="weapon in selectedWeapons" :data-id="weapon.id" class="slot weapon selected" :class="weapon.type" :title="weapon.name" @click="toggleItem(weapon)" @mouseenter="onMouseEnter(weapon)" @mouseleave="onMouseLeave(weapon)">
                  <div :style="weapon.style"></div>
                </div>
                <div v-for="i in (selectedWeapons.length < 7 ? 6 - selectedWeapons.length : 0)" class="slot weapon">
                  <div class="empty">WEAPON</div>
                </div>
              </div>

              <div class="flex">
                <div v-for="passive in selectedPassives" :data-id="passive.id" class="slot passive selected" :class="passive.type" :title="passive.name" @click="toggleItem(passive)" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave(passive)">
                  <div :style="passive.style"></div>
                </div>
                <div v-for="i in (selectedPassives.length < 7 ? 6 - selectedPassives.length : 0)" class="slot passive">
                  <div class="empty">PASSIVE</div>
                </div>
              </div>
            </div>
          </div>
          <div class="buttons">
            <div class="button" @click="reset()">RESET</div>
            <div class="button" @click="copy($event)">COPY LINK</div>
            <div class="button" @click="save()">SAVE IMAGE</div>
            <div class="button" @click="config.pixels = !config.pixels">PIXELS: {{config.pixels ? 'ON' : 'OFF'}}</div>
            <div class="button" @click="config.evolutions = !config.evolutions">EVOLUTIONS: {{config.evolutions ? 'ON' : 'OFF'}}</div>
            <div class="flex">
              <div class="button" @click="config.size -= 0.1">SIZE -</div>
              <div class="button" @click="config.size += 0.1">SIZE +</div>
            </div>
          </div>
        </header>

        <!-- Characters -->
        <section style="max-width: 60em">
          <div class="objects">
            <div v-for="character in characters" :data-id="character.id" class="object character" :class="{selected: selectedCharacter && selectedCharacter.id === character.id}" @click="selectCharacter(character)" @mouseenter="onMouseEnter(character)" @mouseleave="onMouseLeave(character)">
              <div class="character" :style="character.style" :title="character.name"></div>
              <div class="weapons">
                <div v-for="item in character.items" :title="item.name">
                  <div :style="item.style"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Weapons -->
        <section style="max-width: 65em">
          <div class="objects">
            <div v-for="weapon in weapons" :data-id="weapon.id" class="object weapon" :class="{selected: isSelectedId(weapon.id), center: !weapon.itemIds.length || !config.evolutions}" @click="toggleItem(weapon)" @mouseenter="onMouseEnter(weapon)" @mouseleave="onMouseLeave(weapon)">
              <div class="weapon" :title="weapon.name">
                <div :style="weapon.style"></div>
              </div>
              <div v-if="weapon.impacts && config.impacts" class="impacts">
                <div v-for="impact in weapon.impacts" :style="impact.style" :title="impact.name"></div>
              </div>
              <div v-if="weapon.items && config.evolutions" class="evolutions">
                <div v-for="object in weapon.items" :title="object.name">
                  <div :style="object.style"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Passives -->
        <section style="max-width: 45em">
          <div class="objects">
            <div v-for="passive in passives" :data-id="passive.id" class="object passive" :class="{selected: isSelectedId(passive.id), center: !passive.itemIds.length || !config.evolutions }" @click="toggleItem(passive)" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave(passive)">
              <div class="passive" :title="passive.name">
                <div :style="passive.style"></div>
              </div>
              <div v-if="passive.items && config.evolutions" class="weapons">
                <div v-for="object in passive.items" :title="object.name">
                  <div :style="object.style"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Footer -->
        <footer>
          <small class="socials">
            <span>Vampire Survivors:</span>
            <a class="social" href="https://store.steampowered.com/app/1794680/Vampire_Survivors/" target="_blank"><img src="./img/steam.svg" alt="" /></a>
            <a class="social" href="https://twitter.com/poncle_vampire" target="_blank"><img src="./img/twitter.svg" alt="" /></a>
            <a class="social" href="https://www.instagram.com/vampire_survivors/" target="_blank"><img src="./img/instagram.svg" alt="" /></a>
            <a class="social" href="https://www.tiktok.com/@vampire_survivors" target="_blank"><img src="./img/tiktok.svg" alt="" /></a>
            <a class="social" href="https://discord.com/invite/vampire-survivors" target="_blank"><img src="./img/discord.svg" alt="" /></a>
            <a class="social" href="https://www.reddit.com/r/VampireSurvivors/" target="_blank"><img src="./img/reddit.svg" alt="" /></a>
          </small>
          <small>Website is made by <a class="author" href="mailto:danmer.ekb@gmail.com">Danmer</a>, 2022</small>
        </footer>
      </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.32/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script>
      const { createApp, ref, reactive, computed, watch, watchEffect, h } = Vue

      createApp({
        setup() {
          const defaultConfig = { impacts: false, pixels: true, evolutions: true, size: 1, version: '0.5.0' }
          const userConfig = JSON.parse(localStorage.getItem('vs-build') || '{}')
          const config = reactive(Object.assign({}, defaultConfig, userConfig))

          const characters = reactive([
            // common
            { type: 'common', name: 'Antonio', id: 'antonio', image: 'Antonio', itemIds: ['whip'] },
            { type: 'common', name: 'Imelda', id: 'imelda', image: 'Imelda', itemIds: ['magicwand'] },
            { type: 'common', name: 'Pasqualina', id: 'pasqualina', image: 'Pasqualina', itemIds: ['runetracer'] },
            { type: 'common', name: 'Gennaro', id: 'gennaro', image: 'Gennaro', itemIds: ['knife'] },
            { type: 'common', name: 'Arca', id: 'arca', image: 'Arca', itemIds: ['firewand'] },
            { type: 'common', name: 'Porta', id: 'porta', image: 'Porta', itemIds: ['lightning'] },
            { type: 'common', name: 'Lama', id: 'lama', image: 'Lama', itemIds: ['axe'] },
            { type: 'common', name: 'Poe', id: 'poe', image: 'Old3', itemIds: ['garlic'] },
            { type: 'common', name: 'Clerici', id: 'suora', image: 'Suora', itemIds: ['water'] },
            { type: 'common', name: 'Dommario', id: 'dommario', image: 'Dommario', itemIds: ['bible'] },
            { type: 'common', name: 'Krochi', id: 'krochi', image: 'Krochi', itemIds: ['cross'] },
            { type: 'common', name: 'Christine', id: 'christine', image: 'Christine', itemIds: ['pentagram'] },
            { type: 'common', name: 'Pugnala', id: 'pugnala', image: 'Pugnala', itemIds: ['guns1', 'guns2'] },
            { type: 'common', name: 'Poppea', id: 'poppea', image: 'Poppea', itemIds: ['mana'] },
            { type: 'common', name: 'Mortaccio', id: 'mortaccio', image: 'Mortaccio', itemIds: ['bone'] },
            { type: 'common', name: 'Cavallo', id: 'cavallo', image: 'Cavallo', itemIds: ['cherry'] },
            { type: 'common', name: 'Ramba', id: 'ramba', image: 'Ramba', itemIds: ['cart'] },
            { type: 'common', name: 'Giovanna', id: 'giovanna', image: 'Giovanna', itemIds: ['cat'] },
            // secret
            { type: 'secret', name: 'Exdash', id: 'exdash', image: 'Exdash', itemIds: ['bird2'] },
            { type: 'secret', name: 'Toastie', id: 'uexdash', image: 'uExdash', itemIds: ['bird1'] },
            { type: 'secret', name: 'Reaper', id: 'reaper', image: 'XLReaper', itemIds: ['axe_'] },
            // { type: "secret", name: "Leda", id: "leda", itemIds: ["magicwand_"] },
          ])

          const items = reactive([
            // weapons
            { type: 'weapon', id: 'magicwand', name: 'Magic Wand', image: 'WandHoly' },
            { type: 'weapon', id: 'firewand', name: 'Fire Wand', image: 'WandFire2' },
            { type: 'weapon', id: 'axe', name: 'Axe', image: 'Axe' },
            { type: 'weapon', id: 'lightning', name: 'Lightning Ring', image: 'LighningRing' },
            { type: 'weapon', id: 'knife', name: 'Knife', image: 'Knife' },
            { type: 'weapon', id: 'bible', name: 'King Bible', image: 'HolyBook' },
            { type: 'weapon', id: 'cross', name: 'Cross', image: 'Cross' },
            { type: 'weapon', id: 'garlic', name: 'Garlic', image: 'Garlic' },
            { type: 'weapon', id: 'pentagram', name: 'Pentagram', image: 'Pentagram' },
            { type: 'weapon', id: 'runetracer', name: 'Runetracer', image: 'Diamond2' },
            { type: 'weapon', id: 'water', name: 'Santa Water', image: 'HolyWater' },
            { type: 'weapon', id: 'mana', name: 'Song of Mana', image: 'Song' },
            { type: 'weapon', id: 'whip', name: 'whip', image: 'Whip' },
            { type: 'weapon', id: 'guns1', name: 'Phiera Der Tuphello', image: 'Guns' },
            { type: 'weapon', id: 'guns2', name: 'Eight The Sparrow', image: 'Guns2' },
            { type: 'weapon', id: 'bird1', name: 'Peachone', image: 'Silf1' },
            { type: 'weapon', id: 'bird2', name: 'Ebony Wings', image: 'Silf2' },
            { type: 'weapon', id: 'lancet', name: 'Clock Lancet', image: 'Lancet' },
            { type: 'weapon', id: 'laurel', name: 'Laurel', image: 'Laurel' },
            { type: 'weapon', id: 'bone', name: 'bone', image: 'Bone' },
            { type: 'weapon', id: 'cherry', name: 'Cherry Bomb', image: 'Cherry' },
            { type: 'weapon', id: 'cart', name: 'Carréllo', image: 'CartWheel' },
            { type: 'weapon', id: 'cat', name: 'Gatti Amari', image: 'Cat' },
            // evolutions
            { type: 'evolution', id: 'magicwand_', name: 'Holy Wand', image: 'WandHoly2', itemIds: ['magicwand', 'cooldown'] },
            { type: 'evolution', id: 'firewand_', name: 'Hellfire', image: 'Hellfire', itemIds: ['firewand', 'might'] },
            { type: 'evolution', id: 'axe_', name: 'Death Spiral', image: 'Scythe', itemIds: ['axe', 'area'] },
            { type: 'evolution', id: 'lightning_', name: 'Thunder Loop', image: 'Thunderloop', itemIds: ['lightning', 'amount'] },
            { type: 'evolution', id: 'knife_', name: 'Thousand Edge', image: 'Knife2', itemIds: ['knife', 'speed'] },
            { type: 'evolution', id: 'bible_', name: 'Unholy Vespers', image: 'UnholyBook', itemIds: ['bible', 'duration'] },
            { type: 'evolution', id: 'cross_', name: 'Heaven Sword', image: 'HeavenSword', itemIds: ['cross', 'luck'] },
            { type: 'evolution', id: 'garlic_', name: 'Soul Eater', image: 'OrbOrange', itemIds: ['garlic', 'recovery'] },
            { type: 'evolution', id: 'pentagram_', name: 'Gorgeous Moon', image: 'Pentagram2', itemIds: ['pentagram', 'growth'] },
            { type: 'evolution', id: 'runetracer_', name: 'NO FUTURE', image: 'Carnage', itemIds: ['runetracer', 'armor'] },
            { type: 'evolution', id: 'water_', name: 'La Borra', image: 'Water2', itemIds: ['water', 'magnet'] },
            { type: 'evolution', id: 'mana_', name: 'Mannajja', image: 'Song2', itemIds: ['mana', 'curse'] },
            { type: 'evolution', id: 'whip_', name: 'Bloody Tear', image: 'Whip2', itemIds: ['whip', 'health'] },
            { type: 'evolution', id: 'guns_', name: 'Phieraggi', image: 'Guns3', itemIds: ['guns1', 'guns2', 'revival'] },
            { type: 'evolution', id: 'bird_', name: 'Vandalier', image: 'Silf3', itemIds: ['bird1', 'bird2'] },
            // passives
            { type: 'passive', id: 'cooldown', name: 'Empty tome', image: 'Book2', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'garlic', 'pentagram', 'runetracer', 'water', 'mana', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'lancet', 'laurel', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'garlic_', 'pentagram_', 'runetracer_', 'water_', 'mana_', 'whip_', 'guns_', 'bird_'] },
            { type: 'passive', id: 'might', name: 'Spinach', image: 'Leaf', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'garlic', 'runetracer', 'water', 'mana', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'garlic_', 'runetracer_', 'water_', 'mana_', 'whip_', 'guns_', 'bird_'] },
            { type: 'passive', id: 'area', name: 'Candelabrador', image: 'Candelabra', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'garlic', 'runetracer', 'water', 'mana', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'garlic_', 'runetracer_', 'water_', 'mana_', 'whip_', 'guns_', 'bird_'] },
            { type: 'passive', id: 'amount', name: 'Duplicator', image: 'Ring', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'runetracer', 'water', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'runetracer_', 'water_', 'whip_', 'guns_', 'bird_'] },
            { type: 'passive', id: 'speed', name: 'Bracer', image: 'Gauntlet', impactIds: ['magicwand', 'firewand', 'axe', 'knife', 'bible', 'cross', 'runetracer', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'knife_', 'bible_', 'cross_', 'runetracer_', 'water_', 'guns_', 'bird_'] },
            { type: 'passive', id: 'duration', name: 'Spellbinder', image: 'EmblemEye', impactIds: ['bible', 'runetracer', 'water', 'mana', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'lancet', 'bible_', 'runetracer_', 'water_', 'mana_', 'bird_'] },
            { type: 'passive', id: 'luck', name: 'Clover', image: 'Clover', impactIds: ['knife', 'pentagram', 'guns1', 'guns2', 'cherry', 'cat', 'knife_', 'cross_', 'whip_', 'guns_'] },
            { type: 'passive', id: 'recovery', name: 'Pummarola', image: 'HeartRuby', impactIds: ['garlic_'] },
            { type: 'passive', id: 'growth', name: 'Crown', image: 'Crown' },
            { type: 'passive', id: 'armor', name: 'Armor', image: 'ArmorIron' },
            { type: 'passive', id: 'magnet', name: 'Attractorb', image: 'OrbGlow' },
            { type: 'passive', id: 'curse', name: "Skull O'Maniac", image: 'Curse' },
            { type: 'passive', id: 'health', name: 'Hollow Heart', image: 'HeartBlack' },
            { type: 'passive', id: 'revival', name: 'Tiragisú', image: 'Tiramisu', impactIds: ['guns_'] },
            { type: 'passive', id: 'wings', name: 'Wings', image: 'Wing', impactIds: ['bird1', 'bird2', 'water_', 'bird_'] },
            { type: 'passive', id: 'greed', name: 'Stone Mask', image: 'Mask' },
          ])

          const itemsById = keyById(items)
          const charactersById = keyById(characters)

          for (const item of items) {
            item.itemIds = item.itemIds || []
            // evolution
            const evolution = items.find((item2) => item2.type === 'evolution' && item2.itemIds.includes(item.id))
            if (evolution) {
              evolution[item.type + 'Ids'] = evolution[item.type + 'Ids'] || []
              evolution[item.type + 's'] = evolution[item.type + 's'] || []
              evolution[item.type + 'Ids'].push(item.id)
              evolution[item.type + 's'].push(item)
              item.evolutionId = evolution.id
              item.evolution = evolution
              item.itemIds = evolution ? evolution.itemIds.filter((itemId) => itemId !== item.id) : []
            }
            if (!item.impactIds) {
              item.impactIds = items.filter((item2) => item2.impactIds && item2.impactIds.includes(item.id)).map((item2) => item2.id)
            }
            // impacts
            item.impacts = item.impactIds.map((id) => itemsById[id])
            // items
            item.items = item.itemIds.map((id) => itemsById[id])
          }

          for (const character of characters) {
            if (character.itemIds) {
              character.items = items.filter((item) => character.itemIds.includes(item.id))
            }
          }

          window.vs = { config, items, characters, itemsById, charactersById }
          console.log({ config, items, characters, itemsById, charactersById })

          const hashIds = location.hash.substring(1).split(',')

          const selectedCharacterId = ref(hashIds.find((id) => charactersById[id]))
          const selectedItemIds = reactive(hashIds.filter((id) => itemsById[id]))

          const weapons = computed(() => items.filter((item) => item.type === 'weapon'))
          const evolutions = computed(() => items.filter((item) => item.type === 'evolution'))
          const passives = computed(() => items.filter((item) => item.type === 'passive'))

          const selectedCharacter = computed(() => characters.find((character) => character.id === selectedCharacterId.value))
          const selectedItems = computed(() => selectedItemIds.map((itemId) => itemsById[itemId]))
          const selectedPassives = computed(() => selectedItems.value.filter((item) => item.type === 'passive'))
          const selectedWeapons = computed(() => {
            const weaponIds = []
            for (const item of selectedItems.value) {
              if (item.type === 'evolution' && selectedCharacter.value.itemIds.includes(item.id)) {
                weaponIds.push(item.id)
              }
              if (item.type === 'weapon') {
                if (item.evolution && item.evolution.itemIds.every((itemId) => selectedItemIds.includes(itemId)) && !selectedItemIds.includes(item.evolutionId)) {
                  if (!weaponIds.includes(item.evolutionId)) {
                    weaponIds.push(item.evolutionId)
                  }
                } else {
                  weaponIds.push(item.id)
                }
              }
            }
            return weaponIds.map((weaponId) => itemsById[weaponId])
          })

          watchEffect(() => {
            location.hash = [selectedCharacterId.value].concat(selectedItemIds).join()
          })

          watch(
            selectedCharacter,
            (newCharacter, oldCharacter) => {
              if (oldCharacter) {
                if (oldCharacter && oldCharacter.itemIds) {
                  for (const itemId of oldCharacter.itemIds) {
                    removeItemId(itemId)
                  }
                }
              }
              if (newCharacter) {
                for (const item of newCharacter.items) {
                  if (item.type === 'evolution') {
                    for (const weaponId of item.weaponIds) {
                      removeItemId(weaponId)
                    }
                  } else {
                    removeItemId(item.id)
                  }
                  if (!selectedItems.value.find((item2) => item2.type === 'evolution' && item2.itemIds.includes(item.id))) {
                    prependItemId(item.id)
                  }
                }
              }
            },
            { immediate: true }
          )

          watch(config, () => {
            for (const param in config) {
              if (config[param] === defaultConfig[param]) {
                delete userConfig[param]
              } else {
                userConfig[param] = config[param]
              }
            }
            localStorage.setItem('vs-build', JSON.stringify(userConfig))
          })

          watch(
            () => config.version,
            () => {
              getFramesById(`characters`, /(.+)_(.\d+)\.png/).then((framesById) => {
                for (const character of characters) {
                  character.frames = framesById[character.image] || []
                  character.style = character.frames.length ? character.frames[0].style : {}
                }
              })
              getFramesById(`items`, /(.+)\.png/).then((framesById) => {
                for (const item of items) {
                  item.frames = framesById[item.image] || []
                  item.style = item.frames.length ? item.frames[0].style : {}
                }
              })
            },
            { immediate: true }
          )

          function onMouseEnter(object) {
            if (!object) {
              return
            }
            if (object.itemIds) {
              for (const itemId of object.itemIds) {
                document.querySelectorAll(`[data-id="${itemId}"]`).forEach((element) => {
                  element.classList.add('yellow')
                })
              }
            }
            if (object.impactIds) {
              for (const passiveId of object.impactIds) {
                document.querySelectorAll(`[data-id="${passiveId}"]`).forEach((element) => {
                  element.classList.add('green')
                })
              }
            }
            if (object.type === 'passive') {
              for (const item of items) {
                if (item.impactIds && item.impactIds.includes(object.id)) {
                  document.querySelectorAll(`[data-id="${item.id}"]`).forEach((element) => {
                    element.classList.add('green')
                  })
                }
              }
            }
          }

          function onMouseLeave(object) {
            if (!object) {
              return
            }
            if (object.itemIds) {
              for (const itemId of object.itemIds) {
                document.querySelectorAll(`[data-id="${itemId}"]`).forEach((element) => {
                  element.classList.remove('yellow')
                })
              }
            }
            if (object.impactIds) {
              for (const passiveId of object.impactIds) {
                document.querySelectorAll(`[data-id="${passiveId}"]`).forEach((element) => {
                  element.classList.remove('green')
                })
              }
            }
            if (object.type === 'passive') {
              for (const item of items) {
                if (item.impactIds && item.impactIds.includes(object.id)) {
                  document.querySelectorAll(`[data-id="${item.id}"]`).forEach((element) => {
                    element.classList.remove('green')
                  })
                }
              }
            }
          }

          function selectCharacter(newCharacter) {
            selectedCharacterId.value = newCharacter.id
          }

          function toggleItem(item) {
            if (item.type === 'evolution') {
              for (const weapon of item.weapons) {
                toggleItem(weapon)
              }
            } else {
              if (isSelectedId(item.id) && !selectedCharacter.value.itemIds.includes(item.id)) {
                removeItemId(item.id)
              } else {
                appendItemId(item.id)
              }
            }
          }

          function isSelectedId(itemId) {
            return selectedItems.value.find((selectedItem) => selectedItem.id === itemId || (selectedItem.type === 'evolution' && selectedItem.items.find((item) => item.type === 'weapon' && item.id === itemId)))
          }

          function appendItemId(newItemId) {
            // console.log("appendItemId", newItemId);
            if (!selectedItemIds.includes(newItemId)) {
              selectedItemIds.push(newItemId)
            }
          }

          function prependItemId(newItemId) {
            // console.log("prependItemId", newItemId);
            if (!selectedItemIds.includes(newItemId)) {
              selectedItemIds.unshift(newItemId)
            }
          }

          function removeItemId(itemId) {
            // console.log("removeItemId", itemId);
            const itemIndex = selectedItemIds.indexOf(itemId)
            if (itemIndex !== -1) {
              onMouseLeave(selectedItems.value[itemIndex])
              selectedItemIds.splice(itemIndex, 1)
            }
          }

          let animationIndex = 0
          function startAnimation(character) {
            animationIndex = 0
            if (!character.animation && character.frames.length) {
              animate(character)
            }
          }
          function stopAnimation(character) {
            clearTimeout(character.animation)
            character.animation = 0
          }
          function animate(character) {
            animationIndex = animationIndex === character.frames.length - 1 ? 0 : animationIndex + 1
            character.style = character.frames[animationIndex].style
            character.animation = setTimeout(animate.bind(this, character), 200)
          }

          function reset() {
            selectedCharacterId.value = ''
            selectedItemIds.length = 0
          }

          function save() {
            domtoimage.toPng(document.querySelector('.slots')).then((dataUrl) => {
              console.log({ dataUrl })
              var link = document.createElement('a')
              link.download = `vs-build_${new Date().toISOString().substring(0, 19).replaceAll(':', '-')}.png`
              link.href = dataUrl
              link.click()
              // window.saveAs(blob, 'my-node.png');
            })
          }

          function copy(event) {
            const text = location.href
            navigator.clipboard.writeText(text).then(() => {
              const target = event.target
              if (target) {
                target.style.color = '#3c3'
                setTimeout(() => {
                  target.style.color = ''
                }, 200)
              }
            })
          }

          function keyById(items) {
            return items.reduce((object, item) => {
              object[item.id] = item
              return object
            }, {})
          }

          function getFramesById(name, regex) {
            return fetch(`./assets/${name}_${config.version}.json`)
              .then((res) => res.json())
              .then((data) => {
                const texture = data.textures[0]
                const framesById = {}
                for (const frame of texture.frames) {
                  const [filename, id] = frame.filename.match(regex) || []
                  if (id) {
                    const k = 1 / 10
                    const p = 0.1
                    const { w, h, x, y } = frame.frame
                    const mx = w < h ? ((h - w) * k) / 2 : 0
                    const my = w > h ? ((w - h) * k) / 2 : 0
                    const style = {
                      margin: name === 'items' ? `${my}em ${mx}em` : 0,
                      padding: `${p}em`,
                      width: `${w * k + p * 2}em`,
                      height: `${h * k + p * 2}em`,
                      backgroundImage: `url("./assets/${name}_${config.version}.png")`,
                      backgroundSize: `${texture.size.w * k}em ${texture.size.h * k}em`,
                      backgroundPosition: `-${x * k - p}em -${y * k - p}em`,
                    }
                    framesById[id] = framesById[id] || []
                    framesById[id].push({ id, w, h, x, y, style })
                  }
                }
                // console.log(name, Object.keys(framesById))
                return framesById
              })
          }

          return {
            config,
            characters,
            weapons,
            passives,
            evolutions,
            selectedCharacter,
            selectedWeapons,
            selectedPassives,
            startAnimation,
            stopAnimation,
            onMouseEnter,
            onMouseLeave,
            selectCharacter,
            toggleItem,
            isSelectedId,
            save,
            copy,
            reset,
          }
        },
      }).mount('#app')
    </script>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
      ;(function (m, e, t, r, i, k, a) {
        m[i] =
          m[i] ||
          function () {
            ;(m[i].a = m[i].a || []).push(arguments)
          }
        m[i].l = 1 * new Date()
        ;(k = e.createElement(t)), (a = e.getElementsByTagName(t)[0]), (k.async = 1), (k.src = r), a.parentNode.insertBefore(k, a)
      })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym')
      ym(88260279, 'init', { clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true, trackHash: true })
    </script>
    <noscript>
      <div><img src="https://mc.yandex.ru/watch/88260279" style="position: absolute; left: -9999px" alt="" /></div>
    </noscript>
    <!-- /Yandex.Metrika counter -->
  </body>
</html>
